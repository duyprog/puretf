name: TF Apply (prod)

on:
  push:
    branches: [ "prod" ]
    paths:
      - 'envs/prod/**'
      - 'modules/**'

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.mk.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - uses: tj-actions/changed-files@v45
        id: cf
      - id: mk
        run: |
          changed="$(printf '%s\n' ${{ steps.cf.outputs.all_changed_files }})"
          list=""
          if echo "$changed" | grep -q '^modules/'; then
            for d in envs/prod/*; do
              [ -d "$d" ] || continue
              stack=$(basename "$d")
              list="${list}{\"env\":\"prod\",\"stack\":\"${stack}\",\"region\":\"us-east-1\",\"account_id\":\"123456789012\"},"
            done
          else
            while IFS= read -r f; do
              case "$f" in
                envs/prod/*/*)
                  stack=$(echo "$f" | cut -d/ -f3)
                  echo "$stack"
                ;;
              esac
            done <<< "$changed" | sort -u | while read -r s; do
              list="${list}{\"env\":\"prod\",\"stack\":\"${s}\",\"region\":\"us-east-1\",\"account_id\":\"123456789012\"},"
            done
          fi
          json="{\"include\":[${list%,}]}"
          echo "matrix=$json" >> "$GITHUB_OUTPUT"

  apply:
    needs: discover
    if: ${{ fromJson(needs.discover.outputs.matrix).include != null && (join(fromJson(needs.discover.outputs.matrix).include, '') != '') }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
    uses: ./.github/workflows/tf-reusable.yml
    with:
      env: prod
      stack: ${{ matrix.stack }}
      region: us-east-1
      account_id: 123456789012
      apply: true
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}